<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metal Border Generator PRO</title>
  <style>
    :root {
      --border-size: 12; --radius: 24; --base-angle: 24; --scroll-progress: 0; --scroll-drive: 1;
      --light-elevation: 0.78; --light-intensity: 1.2; --preview-width: 260; --preview-height: 90;
      --auto-border-enable: 1;
      --m-enable: 0; --m-width: 12; --m-offset: 0; --o-enable: 0; --o-width: 4; --o-offset: 0;
      --s-enable: 0; --s-width: 6; --s-offset: 0; --i-enable: 0; --i-width: 4; --i-offset: 0;
      --m-bg-enable: 0; --o-bg-enable: 0; --s-bg-enable: 0; --i-bg-enable: 0;
      --m-bg-animate: 0; --o-bg-animate: 0; --s-bg-animate: 0; --i-bg-animate: 0;
      --m-conic-enable: 0; --o-conic-enable: 0; --s-conic-enable: 0; --i-conic-enable: 0;
      --m-fresnel-enable: 0; --o-fresnel-enable: 0; --s-fresnel-enable: 0; --i-fresnel-enable: 0;
      --m-texture-enable: 0; --o-texture-enable: 0; --s-texture-enable: 0; --i-texture-enable: 0;
      --m-layer-enable: 0; --o-layer-enable: 0; --s-layer-enable: 0; --i-layer-enable: 0;
      --shadow-enable: 0; --outer-shadow-x: 0; --outer-shadow-y: 10; --outer-shadow-blur: 24;
      --outer-shadow-r: 0; --outer-shadow-g: 0; --outer-shadow-b: 0; --outer-shadow-a: 0.3;
      --g1-r: 250; --g1-g: 252; --g1-b: 255; --g1-a: 0.95; --g2-r: 194; --g2-g: 204; --g2-b: 220; --g2-a: 0.88;
      --g3-r: 134; --g3-g: 146; --g3-b: 166; --g3-a: 0.82; --g4-r: 75; --g4-g: 86; --g4-b: 104; --g4-a: 0.9;
      --g5-r: 38; --g5-g: 47; --g5-b: 61; --g5-a: 0.92; --g6-r: 223; --g6-g: 238; --g6-b: 255; --g6-a: 0.7;
    }
    @property --scroll-progress { syntax: "<number>"; inherits: true; initial-value: 0; }
    *{box-sizing:border-box} body{margin:0;min-height:280vh;font-family:Inter,system-ui,sans-serif;color:#f2f6ff;background:radial-gradient(circle at 12% 10%, #33456f 0, #171d30 43%, #0b0f17 100%)}
    .layout{display:grid;grid-template-columns:minmax(340px,500px) 1fr;gap:1rem;padding:1rem;align-items:start}
    .panel{position:sticky;top:.5rem;max-height:calc(100vh - 1rem);overflow:auto;padding:.9rem;border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(16,20,33,.88)}
    .cap{display:flex;justify-content:space-between;gap:.4rem;align-items:center} label{display:block;margin:.34rem 0;font-size:.77rem}
    input[type="range"],select,button{width:100%;font:inherit}.row2{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.45rem}
    .acc,.sub-acc{border:1px solid rgba(255,255,255,.12);border-radius:12px;margin:.45rem 0;background:rgba(255,255,255,.02)}
    .acc>summary,.sub-acc>summary{cursor:pointer;list-style:none;padding:.52rem .6rem;font-size:.82rem;font-weight:600;display:flex;justify-content:space-between;gap:.5rem;align-items:center}
    .acc>summary::-webkit-details-marker,.sub-acc>summary::-webkit-details-marker{display:none}.acc-body,.sub-body{padding:.15rem .55rem .55rem}.sub-acc{margin:.35rem 0}
    .toggle-wrap{display:flex;align-items:center;gap:.35rem;white-space:nowrap;font-size:.72rem}.toggle-wrap input{width:auto}.disabled{opacity:.42;pointer-events:none}
    .pal-btn{padding:.44rem;border-radius:10px;border:1px solid rgba(255,255,255,.2);cursor:pointer;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.75);font-weight:600}
    .stop-editor{position:relative;height:30px;border-radius:8px;border:1px solid rgba(255,255,255,.2);margin:.35rem 0 .15rem;overflow:hidden}
    .stop-handle{position:absolute;top:0;bottom:0;width:12px;transform:translateX(-50%);border:2px solid #fff;background:rgba(0,0,0,.45);border-radius:4px;cursor:ew-resize}
    .stage{min-height:260vh;position:relative}
    
    .picker{position:fixed;z-index:60;right:1rem;top:1rem;width:min(94vw,320px);padding:.7rem;border-radius:14px;border:1px solid rgba(255,255,255,.2);background:rgba(9,13,23,.98)} .picker.hidden{display:none}
    .sv-wrap{position:relative;height:168px;border-radius:10px;overflow:hidden;cursor:crosshair}.picker-handle{position:absolute;width:14px;height:14px;border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%)} .num{font-size:.72rem;opacity:.85}
    @supports (animation-timeline: scroll()) { body{animation:prog linear both;animation-timeline:scroll(root);animation-range:0% 100%}@keyframes prog{from{--scroll-progress:0}to{--scroll-progress:1}} }
    @media (max-width:930px){ .layout{grid-template-columns:1fr}.panel{position:fixed;left:.6rem;right:.6rem;bottom:.6rem;top:auto;max-height:55vh;z-index:20}.stage{min-height:320vh} }
  </style>
  <link rel="stylesheet" href="metal-core.css" />
</head>
<body>
<div class="layout"><aside class="panel"><h2>Metal Border Generator PRO</h2>
<p class="hint">Single-element <code>.paint-metal</code> render with separate editor/runtime code blocks.</p>
<details class="acc" open><summary>Global Geometry + Light</summary><div class="acc-body">
<label><span class="cap">Auto border from 3 bands <output data-out="--auto-border-enable"></output></span><select data-var="--auto-border-enable"><option value="1">On</option><option value="0">Off</option></select></label>
<label><span class="cap">Computed border size <output data-out="--border-size"></output></span><input data-var="--border-size" type="range" min="0" max="160" step="0.1" value="12"></label>
<label><span class="cap">Radius <output data-out="--radius"></output></span><input data-var="--radius" type="range" min="0" max="160" step="1" value="24"></label>
<label><span class="cap">Preview width <output data-out="--preview-width"></output></span><input data-var="--preview-width" type="range" min="0" max="1400" step="1" value="260"></label>
<label><span class="cap">Preview height <output data-out="--preview-height"></output></span><input data-var="--preview-height" type="range" min="0" max="1100" step="1" value="90"></label>
<label><span class="cap">Base angle <output data-out="--base-angle"></output></span><input data-var="--base-angle" type="range" min="0" max="360" step="1" value="24"></label>
<label><span class="cap">Scroll drive <output data-out="--scroll-drive"></output></span><input data-var="--scroll-drive" type="range" min="0" max="8" step="0.01" value="1"></label>
<label><span class="cap">Light elevation <output data-out="--light-elevation"></output></span><input data-var="--light-elevation" type="range" min="0" max="1" step="0.01" value="0.78"></label>
<label><span class="cap">Light intensity <output data-out="--light-intensity"></output></span><input data-var="--light-intensity" type="range" min="0" max="4" step="0.01" value="1.2"></label>
<div class="row2"><button type="button" id="save-settings">Save local</button><button type="button" id="clear-settings">Clear local</button></div>
<div class="row2"><button type="button" id="export-settings">Export JSON</button><button type="button" id="import-settings">Import JSON</button></div><input id="import-settings-file" type="file" accept="application/json" style="display:none">
</div></details>
<details class="acc"><summary>Global Palette</summary><div class="acc-body" id="global-palette"></div></details>
<details class="acc"><summary>Main + 3 Border Bands</summary><div class="acc-body" id="bands"></div></details>
<details class="acc"><summary>Outer Shadow <span class="toggle-wrap"><input type="checkbox" data-check-var="--shadow-enable"><span>enabled</span></span></summary><div class="acc-body" data-group="--shadow-enable">
<label><span class="cap">X <output data-out="--outer-shadow-x"></output></span><input data-var="--outer-shadow-x" type="range" min="-60" max="60" step="1" value="0"></label>
<label><span class="cap">Y <output data-out="--outer-shadow-y"></output></span><input data-var="--outer-shadow-y" type="range" min="-60" max="60" step="1" value="10"></label>
<label><span class="cap">Blur <output data-out="--outer-shadow-blur"></output></span><input data-var="--outer-shadow-blur" type="range" min="0" max="120" step="1" value="24"></label>
<label><span class="cap">Alpha <output data-out="--outer-shadow-a"></output></span><input data-var="--outer-shadow-a" type="range" min="0" max="1" step="0.01" value="0.3"></label>
</div></details></aside>
<main class="stage"><div class="paint-metal"></div></main></div>
<div id="color-picker" class="picker hidden" role="dialog"><div class="cap"><strong id="picker-title">Palette color</strong><button id="picker-close" type="button">Close</button></div><p class="num">SV field + Hue + Alpha</p><div id="sv-area" class="sv-wrap"><span id="sv-handle" class="picker-handle"></span></div><label><span class="cap">Hue <output id="picker-hue-out" class="num"></output></span><input id="picker-hue" type="range" min="0" max="360" step="1"></label><label><span class="cap">Alpha <output id="picker-alpha-out" class="num"></output></span><input id="picker-alpha" type="range" min="0" max="1" step="0.01"></label><div class="row2"><div><span class="num">HEX</span><div id="picker-hex" class="num"></div></div><div><span class="num">RGBA</span><div id="picker-rgba" class="num"></div></div></div></div>

<script>
/* ===== ACTUAL METAL RUNTIME (external files) ===== */
window.addEventListener('DOMContentLoaded',()=>window.initMetalPaint?.('metal-stack-worklet.js'));

/* ===== EDITOR RUNTIME (UI, persistence, import/export) ===== */
const root=document.documentElement, blendLabels=['Normal','Overlay','Screen','Multiply','Soft light','Hard light','Color dodge','Color burn','Difference','Luminosity'];
const STORAGE_KEY='metal-border-generator-settings-v2', defaultByVar={};
const setVar=(k,v)=>root.style.setProperty(k,String(v)), getVar=(k,f=0)=>{const n=parseFloat(getComputedStyle(root).getPropertyValue(k)); return Number.isFinite(n)?n:f;}, out=(k,v)=>{const o=document.querySelector('[data-out="'+k+'"]'); if(o) o.textContent=String(v);};
function bindVar(el){ const key=el.dataset.var, apply=()=>{ const value=el.type==='checkbox'?(el.checked?1:0):el.value; setVar(key,value); out(key,value); refreshStopEditors(); if(key.endsWith('-a')) refreshPaletteButtons(); if(key.includes('-width')||key.includes('-offset')||key==='--auto-border-enable') updateAutoBorder(); }; if(el.type==='checkbox'){ el.checked=getVar(key,0)>=.5; el.addEventListener('change',apply); } else el.addEventListener('input',apply,{passive:true}); apply(); }
function collectSettings(){ const vars={}; for(const el of document.querySelectorAll('[data-var]')) vars[el.dataset.var]=el.type==='checkbox'?(el.checked?1:0):String(el.value); for(const el of document.querySelectorAll('[data-check-var]')) vars[el.dataset.checkVar]=el.checked?1:0; return {vars,details:[...document.querySelectorAll('details')].map(d=>d.open)}; }
function applySettings(data){ if(!data||!data.vars) return; for(const [k,v] of Object.entries(data.vars)){ setVar(k,v); const el=document.querySelector('[data-var="'+k+'"]'); if(el){ if(el.type==='checkbox') el.checked=parseFloat(v)>=.5; else el.value=String(v);} const chk=document.querySelector('[data-check-var="'+k+'"]'); if(chk) chk.checked=parseFloat(v)>=.5; out(k,v);} if(Array.isArray(data.details)){ const all=[...document.querySelectorAll('details')]; data.details.forEach((v,i)=>{ if(all[i]) all[i].open=!!v; }); } refreshPaletteButtons(); refreshStopEditors(); updateAutoBorder(); for(const chk of document.querySelectorAll('[data-check-var]')) applyGroupState(chk.dataset.checkVar); }
const saveSettingsLocal=()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(collectSettings()));
const loadSettingsLocal=()=>{ try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return false; applySettings(JSON.parse(raw)); return true; }catch(_){ return false; } };
const exportSettings=()=>{ const b=new Blob([JSON.stringify(collectSettings(),null,2)],{type:'application/json'}),a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='metal-border-settings.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); };
const importSettingsText=t=>{ try{ applySettings(JSON.parse(t)); saveSettingsLocal(); }catch(_){ alert('Invalid settings JSON'); } };
function updateAutoBorder(){ if(getVar('--auto-border-enable',1)<.5) return; const o=getVar('--o-enable')?getVar('--o-width')+Math.abs(getVar('--o-offset'))*2:0,s=getVar('--s-enable')?getVar('--s-width')+Math.abs(getVar('--s-offset'))*2:0,i=getVar('--i-enable')?getVar('--i-width')+Math.abs(getVar('--i-offset'))*2:0,v=Math.max(0,o,s,i).toFixed(2); setVar('--border-size',v); const input=document.querySelector('[data-var="--border-size"]'); if(input) input.value=v; out('--border-size',v); }
function rgbToHex(r,g,b){return '#'+[r,g,b].map(v=>Math.max(0,Math.min(255,Math.round(v))).toString(16).padStart(2,'0')).join('')} function hsvToRgb(h,s,v){const c=v*s,x=c*(1-Math.abs((h/60)%2-1)),m=v-c; let r=0,g=0,b=0; if(h<60){r=c;g=x;} else if(h<120){r=x;g=c;} else if(h<180){g=c;b=x;} else if(h<240){g=x;b=c;} else if(h<300){r=x;b=c;} else {r=c;b=x;} return {r:Math.round((r+m)*255),g:Math.round((g+m)*255),b:Math.round((b+m)*255)};} function rgbToHsv(r,g,b){const rn=r/255,gn=g/255,bn=b/255,max=Math.max(rn,gn,bn),min=Math.min(rn,gn,bn),d=max-min; let h=0; if(d){ if(max===rn)h=60*(((gn-bn)/d)%6); else if(max===gn)h=60*(((bn-rn)/d)+2); else h=60*(((rn-gn)/d)+4);} if(h<0)h+=360; return {h,s:max===0?0:d/max,v:max};}
const pickerEl=document.getElementById('color-picker'),svArea=document.getElementById('sv-area'),svHandle=document.getElementById('sv-handle'),hueRange=document.getElementById('picker-hue'),alphaRange=document.getElementById('picker-alpha');
const pickerTitle=document.getElementById('picker-title'),pickerHueOut=document.getElementById('picker-hue-out'),pickerAlphaOut=document.getElementById('picker-alpha-out'),pickerHex=document.getElementById('picker-hex'),pickerRgba=document.getElementById('picker-rgba');
const pickerState={slot:1,h:0,s:0,v:1,a:1}, paletteColor=s=>({r:getVar('--g'+s+'-r',255),g:getVar('--g'+s+'-g',255),b:getVar('--g'+s+'-b',255),a:getVar('--g'+s+'-a',1)});
function applyPicker(){ const rgb=hsvToRgb(pickerState.h,pickerState.s,pickerState.v); setVar('--g'+pickerState.slot+'-r',rgb.r); setVar('--g'+pickerState.slot+'-g',rgb.g); setVar('--g'+pickerState.slot+'-b',rgb.b); setVar('--g'+pickerState.slot+'-a',pickerState.a.toFixed(3)); const aIn=document.querySelector('[data-var="--g'+pickerState.slot+'-a"]'); if(aIn){aIn.value=pickerState.a.toFixed(2); out('--g'+pickerState.slot+'-a',aIn.value);} refreshPaletteButtons(); refreshStopEditors(); }
function renderPicker(){ const rgb=hsvToRgb(pickerState.h,pickerState.s,pickerState.v); svArea.style.background='linear-gradient(to top,#000,transparent),linear-gradient(to right,#fff,hsl('+pickerState.h+' 100% 50%))'; svHandle.style.left=(pickerState.s*100)+'%'; svHandle.style.top=((1-pickerState.v)*100)+'%'; hueRange.value=Math.round(pickerState.h); alphaRange.value=pickerState.a.toFixed(2); pickerHueOut.textContent=Math.round(pickerState.h)+'°'; pickerAlphaOut.textContent=pickerState.a.toFixed(2); pickerHex.textContent=rgbToHex(rgb.r,rgb.g,rgb.b); pickerRgba.textContent='rgba('+rgb.r+', '+rgb.g+', '+rgb.b+', '+pickerState.a.toFixed(2)+')'; applyPicker(); }
function openPicker(slot){ pickerState.slot=slot; const c=paletteColor(slot), hsv=rgbToHsv(c.r,c.g,c.b); pickerState.h=hsv.h; pickerState.s=hsv.s; pickerState.v=hsv.v; pickerState.a=c.a; pickerTitle.textContent='Global G'+slot+' color'; pickerEl.classList.remove('hidden'); renderPicker(); }
function refreshPaletteButtons(){ for(let i=1;i<=6;i++){ const c=paletteColor(i),btn=document.querySelector('[data-pal-btn="'+i+'"]'); if(btn){ btn.style.backgroundColor='rgba('+c.r+','+c.g+','+c.b+','+c.a+')'; btn.textContent='G'+i+' '+rgbToHex(c.r,c.g,c.b).toUpperCase()+' α'+c.a.toFixed(2); } } }
function makeSub(title,pfx,varName,content){ const d=document.createElement('details'); d.className='sub-acc'; d.innerHTML='<summary>'+title+' <span class="toggle-wrap"><input type="checkbox" data-check-var="'+varName+'"><span>enabled</span></span></summary><div class="sub-body" data-group="'+varName+'">'+content+'</div>'; return d; }
function addStopsUI(host,p){ const wrap=document.createElement('div'); wrap.className='sub-acc'; wrap.innerHTML='<summary>Background stops</summary><div class="sub-body"><div class="stop-editor" data-stop-editor="'+p+'">'+[1,2,3,4].map(i=>'<button type="button" class="stop-handle" data-stop-handle="'+p+'-'+i+'"></button>').join('')+'</div></div>'; const b=wrap.querySelector('.sub-body'); for(let i=1;i<=4;i++){ const r=document.createElement('div'); r.className='row3'; r.innerHTML='<label><span class="cap">S'+i+' pos <output data-out="--'+p+'-st'+i+'-pos"></output></span><input data-var="--'+p+'-st'+i+'-pos" type="range" min="0" max="1" step="0.01" value="'+[0,0.28,0.64,1][i-1]+'"></label><label><span class="cap">S'+i+' palette</span><select data-var="--'+p+'-st'+i+'-palette">'+[1,2,3,4,5,6].map(v=>'<option value="'+v+'">G'+v+'</option>').join('')+'</select></label><label><span class="cap">S'+i+' alpha <output data-out="--'+p+'-st'+i+'-alpha"></output></span><input data-var="--'+p+'-st'+i+'-alpha" type="range" min="0" max="1" step="0.01" value="1"></label>'; b.appendChild(r);} host.appendChild(wrap); }
function createBandUI(p,label,d){ const sec=document.createElement('details'); sec.className='acc'; sec.innerHTML='<summary>'+label+' <span class="toggle-wrap"><input type="checkbox" data-check-var="--'+p+'-enable"><span>enabled</span></span></summary><div class="acc-body" data-group="--'+p+'-enable"><label><span class="cap">Width <output data-out="--'+p+'-width"></output></span><input data-var="--'+p+'-width" type="range" min="0" max="48" step="0.1" value="'+d.width+'"></label><label><span class="cap">Offset <output data-out="--'+p+'-offset"></output></span><input data-var="--'+p+'-offset" type="range" min="-36" max="36" step="0.1" value="'+d.offset+'"></label></div>'; const body=sec.querySelector('.acc-body');
  body.appendChild(makeSub('Background / Gradient',p,'--'+p+'-bg-enable','<label><span class="cap">BG type</span><select data-var="--'+p+'-bg-type"><option value="0">Conic</option><option value="1">Linear</option><option value="2">Radial</option></select></label><label><span class="cap">BG angle <output data-out="--'+p+'-bg-angle"></output></span><input data-var="--'+p+'-bg-angle" type="range" min="0" max="360" step="1" value="0"></label><label class="toggle-wrap"><input data-var="--'+p+'-bg-animate" type="checkbox"> Animate BG (scroll)</label><label><span class="cap">BG alpha <output data-out="--'+p+'-bg-alpha"></output></span><input data-var="--'+p+'-bg-alpha" type="range" min="0" max="1" step="0.01" value="1"></label><label><span class="cap">BG blend</span><select data-var="--'+p+'-bg-blend">'+blendLabels.map((n,i)=>'<option value="'+i+'">'+n+'</option>').join('')+'</select></label>')); addStopsUI(body,p);
  body.appendChild(makeSub('Conic Overlay',p,'--'+p+'-conic-enable','<label><span class="cap">Conic on top?</span><select data-var="--'+p+'-conic-order"><option value="1">Yes</option><option value="0">No</option></select></label><label><span class="cap">Conic alpha <output data-out="--'+p+'-conic-alpha"></output></span><input data-var="--'+p+'-conic-alpha" type="range" min="0" max="1" step="0.01" value="0.3"></label><label><span class="cap">Conic blend</span><select data-var="--'+p+'-conic-blend">'+blendLabels.map((n,i)=>'<option value="'+i+'">'+n+'</option>').join('')+'</select></label><label><span class="cap">Arms count <output data-out="--'+p+'-arms-count"></output></span><input data-var="--'+p+'-arms-count" type="range" min="1" max="48" step="1" value="12"></label><label><span class="cap">Arms width <output data-out="--'+p+'-arms-width"></output></span><input data-var="--'+p+'-arms-width" type="range" min="0.01" max="0.99" step="0.01" value="0.3"></label><label><span class="cap">Arms contrast <output data-out="--'+p+'-arms-contrast"></output></span><input data-var="--'+p+'-arms-contrast" type="range" min="0" max="2" step="0.01" value="0.5"></label><label><span class="cap">Arms spin <output data-out="--'+p+'-arms-spin"></output></span><input data-var="--'+p+'-arms-spin" type="range" min="0" max="8" step="0.01" value="1.2"></label>'));
  body.appendChild(makeSub('Fresnel',p,'--'+p+'-fresnel-enable','<label><span class="cap">Strength <output data-out="--'+p+'-fresnel-strength"></output></span><input data-var="--'+p+'-fresnel-strength" type="range" min="0" max="2" step="0.01" value="0.4"></label><label><span class="cap">Width <output data-out="--'+p+'-fresnel-width"></output></span><input data-var="--'+p+'-fresnel-width" type="range" min="0" max="1" step="0.01" value="0.35"></label><label><span class="cap">Power <output data-out="--'+p+'-fresnel-power"></output></span><input data-var="--'+p+'-fresnel-power" type="range" min="0.2" max="8" step="0.01" value="3"></label><div class="row2"><label><span class="cap">Palette</span><select data-var="--'+p+'-fresnel-palette">'+[1,2,3,4,5,6].map(v=>'<option value="'+v+'">G'+v+'</option>').join('')+'</select></label><label><span class="cap">Alpha mul <output data-out="--'+p+'-fresnel-alpha-mul"></output></span><input data-var="--'+p+'-fresnel-alpha-mul" type="range" min="0" max="2" step="0.01" value="1"></label></div>'));
  body.appendChild(makeSub('Texture',p,'--'+p+'-texture-enable','<label><span class="cap">Type</span><select data-var="--'+p+'-texture-type"><option value="0">None</option><option value="1">Path Lines</option><option value="2">Straight Lines</option><option value="3">Conic Lines</option><option value="4">Circle Lines</option><option value="5">Frost</option><option value="6">Noise</option><option value="7">Matted</option><option value="8">Dirt</option><option value="9">Rust</option></select></label><label><span class="cap">Scale <output data-out="--'+p+'-texture-scale"></output></span><input data-var="--'+p+'-texture-scale" type="range" min="0.1" max="8" step="0.01" value="1"></label><label><span class="cap">Strength <output data-out="--'+p+'-texture-strength"></output></span><input data-var="--'+p+'-texture-strength" type="range" min="0" max="1" step="0.01" value="0.3"></label><label><span class="cap">Roughness <output data-out="--'+p+'-texture-roughness"></output></span><input data-var="--'+p+'-texture-roughness" type="range" min="0" max="1" step="0.01" value="0.3"></label><div class="row2"><label><span class="cap">Palette</span><select data-var="--'+p+'-tex-palette">'+[1,2,3,4,5,6].map(v=>'<option value="'+v+'">G'+v+'</option>').join('')+'</select></label><label><span class="cap">Alpha mul <output data-out="--'+p+'-tex-alpha-mul"></output></span><input data-var="--'+p+'-tex-alpha-mul" type="range" min="0" max="2" step="0.01" value="1"></label></div>'));
  body.appendChild(makeSub('Layer Mix + Filters',p,'--'+p+'-layer-enable','<label><span class="cap">Layer blend</span><select data-var="--'+p+'-layer-blend">'+['normal','overlay','screen','multiply','soft-light','hard-light','color-dodge','color-burn','difference','luminosity'].map(v=>'<option>'+v+'</option>').join('')+'</select></label><label><span class="cap">Opacity <output data-out="--'+p+'-layer-opacity"></output></span><input data-var="--'+p+'-layer-opacity" type="range" min="0" max="1" step="0.01" value="1"></label><label><span class="cap">Brightness <output data-out="--'+p+'-layer-brightness"></output></span><input data-var="--'+p+'-layer-brightness" type="range" min="0.2" max="3" step="0.01" value="1"></label><label><span class="cap">Contrast <output data-out="--'+p+'-layer-contrast"></output></span><input data-var="--'+p+'-layer-contrast" type="range" min="0.2" max="3" step="0.01" value="1"></label><label><span class="cap">Saturate <output data-out="--'+p+'-layer-saturate"></output></span><input data-var="--'+p+'-layer-saturate" type="range" min="0" max="4" step="0.01" value="1"></label><label><span class="cap">Hue <output data-out="--'+p+'-layer-hue"></output></span><input data-var="--'+p+'-layer-hue" type="range" min="0" max="360" step="1" value="0"></label><label><span class="cap">Blur <output data-out="--'+p+'-layer-blur"></output></span><input data-var="--'+p+'-layer-blur" type="range" min="0" max="6" step="0.1" value="0"></label>'));
  return sec; }
function readBandStops(p){ const arr=[]; for(let i=1;i<=4;i++) arr.push({i,pos:getVar('--'+p+'-st'+i+'-pos',(i-1)/3),pal:Math.round(getVar('--'+p+'-st'+i+'-palette',i)),alpha:getVar('--'+p+'-st'+i+'-alpha',1)}); return arr.sort((a,b)=>a.pos-b.pos); }
function refreshStopEditors(){ document.querySelectorAll('[data-stop-editor]').forEach(ed=>{ const p=ed.dataset.stopEditor, stops=readBandStops(p); ed.style.background='linear-gradient(90deg,'+stops.map(s=>{ const c=paletteColor(s.pal); return 'rgba('+c.r+','+c.g+','+c.b+','+(c.a*s.alpha)+') '+(s.pos*100)+'%'; }).join(',')+')'; for(let i=1;i<=4;i++){ const h=ed.querySelector('[data-stop-handle="'+p+'-'+i+'"]'); if(h) h.style.left=(Math.max(0,Math.min(1,getVar('--'+p+'-st'+i+'-pos',(i-1)/3)))*100)+'%'; }}); }
function bindStopDrag(){ document.querySelectorAll('.stop-handle').forEach(h=>h.addEventListener('pointerdown',ev=>{ h.setPointerCapture(ev.pointerId); const [p,i]=h.dataset.stopHandle.split('-'), n='--'+p+'-st'+i+'-pos'; const move=e=>{ const r=h.parentElement.getBoundingClientRect(),v=Math.max(0,Math.min(1,(e.clientX-r.left)/Math.max(1,r.width))); setVar(n,v.toFixed(3)); const input=document.querySelector('[data-var="'+n+'"]'); if(input) input.value=v.toFixed(2); out(n,v.toFixed(2)); refreshStopEditors(); }; move(ev); const up=e=>{ h.releasePointerCapture(e.pointerId); h.removeEventListener('pointermove',move); h.removeEventListener('pointerup',up); }; h.addEventListener('pointermove',move); h.addEventListener('pointerup',up); })); }
function applyGroupState(v){ const enabled=getVar(v,0)>=.5, chk=document.querySelector('[data-check-var="'+v+'"]'); if(chk) chk.checked=enabled; document.querySelectorAll('[data-group="'+v+'"]').forEach(n=>n.classList.toggle('disabled',!enabled)); }
for(let i=1;i<=6;i++){ const row=document.createElement('div'); row.className='row2'; row.innerHTML='<label><span class="cap">G'+i+' color</span><button type="button" class="pal-btn" data-pal-btn="'+i+'">Edit G'+i+'</button></label><label><span class="cap">G'+i+' alpha <output data-out="--g'+i+'-a"></output></span><input data-var="--g'+i+'-a" type="range" min="0" max="1" step="0.01" value="'+[0.95,0.88,0.82,0.9,0.92,0.7][i-1]+'"></label>'; document.getElementById('global-palette').appendChild(row); }
const bands=document.getElementById('bands'); bands.appendChild(createBandUI('m','Main Border Band',{width:12,offset:0})); bands.appendChild(createBandUI('o','Outer Bevel',{width:4,offset:0})); bands.appendChild(createBandUI('s','Surface',{width:6,offset:0})); bands.appendChild(createBandUI('i','Inner Bevel',{width:4,offset:0}));
for(const el of document.querySelectorAll('[data-var]')) if(!(el.dataset.var in defaultByVar)) defaultByVar[el.dataset.var]=(el.type==='checkbox')?(el.checked?1:0):el.value; loadSettingsLocal();
for(const el of document.querySelectorAll('[data-var]')) bindVar(el); for(const outEl of document.querySelectorAll('[data-out]')) if(!outEl.textContent) outEl.textContent=getComputedStyle(root).getPropertyValue(outEl.dataset.out).trim();
for(const k of ['m','o','s','i']){ setVar('--'+k+'-bg-type',0); setVar('--'+k+'-bg-blend',0); setVar('--'+k+'-bg-animate',0); setVar('--'+k+'-conic-blend',1); setVar('--'+k+'-conic-order',1); }
for(const chk of document.querySelectorAll('[data-check-var]')){ chk.addEventListener('click',e=>e.stopPropagation()); chk.addEventListener('change',()=>{ setVar(chk.dataset.checkVar,chk.checked?1:0); out(chk.dataset.checkVar,chk.checked?1:0); applyGroupState(chk.dataset.checkVar); updateAutoBorder(); saveSettingsLocal(); }); applyGroupState(chk.dataset.checkVar); }
refreshPaletteButtons(); refreshStopEditors(); bindStopDrag(); updateAutoBorder();
for(const btn of document.querySelectorAll('[data-pal-btn]')) btn.addEventListener('click',()=>openPicker(parseInt(btn.dataset.palBtn,10))); document.getElementById('picker-close').addEventListener('click',()=>pickerEl.classList.add('hidden')); document.addEventListener('pointerdown',e=>{ if(pickerEl.classList.contains('hidden')) return; if(!pickerEl.contains(e.target) && !e.target.closest('[data-pal-btn]')) pickerEl.classList.add('hidden'); });
document.getElementById('save-settings').addEventListener('click',saveSettingsLocal); document.getElementById('clear-settings').addEventListener('click',()=>{ localStorage.removeItem(STORAGE_KEY); alert('Local settings cleared.'); }); document.getElementById('export-settings').addEventListener('click',exportSettings); document.getElementById('import-settings').addEventListener('click',()=>document.getElementById('import-settings-file').click()); document.getElementById('import-settings-file').addEventListener('change',async e=>{const f=e.target.files&&e.target.files[0]; if(!f) return; importSettingsText(await f.text()); e.target.value='';});
hueRange.addEventListener('input',()=>{ pickerState.h=parseFloat(hueRange.value); renderPicker(); },{passive:true}); alphaRange.addEventListener('input',()=>{ pickerState.a=parseFloat(alphaRange.value); renderPicker(); },{passive:true}); svArea.addEventListener('pointerdown',ev=>{ svArea.setPointerCapture(ev.pointerId); const move=e=>{ const r=svArea.getBoundingClientRect(); pickerState.s=Math.max(0,Math.min(1,(e.clientX-r.left)/r.width)); pickerState.v=1-Math.max(0,Math.min(1,(e.clientY-r.top)/r.height)); renderPicker(); }; move(ev); const up=e=>{ svArea.releasePointerCapture(e.pointerId); svArea.removeEventListener('pointermove',move); svArea.removeEventListener('pointerup',up); }; svArea.addEventListener('pointermove',move); svArea.addEventListener('pointerup',up); });
for(const cap of document.querySelectorAll('label .cap')){ cap.style.cursor='pointer'; cap.title='Tap to reset this control to default'; cap.addEventListener('click',()=>{ const input=cap.closest('label')?.querySelector('[data-var]'); if(!input) return; const def=defaultByVar[input.dataset.var]; if(def===undefined) return; if(input.type==='checkbox'){ input.checked=String(def)==='1'; input.dispatchEvent(new Event('change',{bubbles:true})); } else { input.value=String(def); input.dispatchEvent(new Event('input',{bubbles:true})); } saveSettingsLocal(); }); }
document.addEventListener('input',e=>{ if(e.target?.matches('[data-var]')) saveSettingsLocal(); },{passive:true}); document.addEventListener('change',e=>{ if(e.target?.matches('[data-var], [data-check-var]')) saveSettingsLocal(); });
if(!CSS.supports('animation-timeline: scroll()')){ let raf=0; const tick=()=>{ raf=0; setVar('--scroll-progress',Math.max(0,Math.min(1,scrollY/Math.max(1,document.documentElement.scrollHeight-innerHeight))).toFixed(6)); }; addEventListener('scroll',()=>{ if(!raf) raf=requestAnimationFrame(tick); },{passive:true}); tick(); }
</script>
<script src="metal-core.js"></script>
</body></html>
