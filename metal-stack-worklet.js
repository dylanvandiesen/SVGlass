class MetalStackPainter {
  static get inputProperties(){ const p=['--border-size','--radius','--base-angle','--scroll-progress','--scroll-drive','--light-elevation','--light-intensity'];
    for(let i=1;i<=6;i++) p.push('--g'+i+'-r','--g'+i+'-g','--g'+i+'-b','--g'+i+'-a');
    for(const id of ['m','o','s','i']){ p.push('--'+id+'-enable','--'+id+'-width','--'+id+'-offset','--'+id+'-bg-enable','--'+id+'-bg-type','--'+id+'-bg-angle','--'+id+'-bg-alpha','--'+id+'-bg-blend','--'+id+'-bg-animate');
      p.push('--'+id+'-conic-enable','--'+id+'-conic-alpha','--'+id+'-conic-blend','--'+id+'-conic-order','--'+id+'-arms-count','--'+id+'-arms-width','--'+id+'-arms-contrast','--'+id+'-arms-spin');
      p.push('--'+id+'-fresnel-enable','--'+id+'-fresnel-strength','--'+id+'-fresnel-width','--'+id+'-fresnel-power','--'+id+'-fresnel-palette','--'+id+'-fresnel-alpha-mul');
      p.push('--'+id+'-texture-enable','--'+id+'-texture-type','--'+id+'-texture-scale','--'+id+'-texture-strength','--'+id+'-texture-roughness','--'+id+'-tex-palette','--'+id+'-tex-alpha-mul');
      p.push('--'+id+'-layer-enable','--'+id+'-layer-blend','--'+id+'-layer-opacity','--'+id+'-layer-brightness','--'+id+'-layer-contrast','--'+id+'-layer-saturate','--'+id+'-layer-hue','--'+id+'-layer-blur');
      for(let s=1;s<=4;s++) p.push('--'+id+'-st'+s+'-pos','--'+id+'-st'+s+'-palette','--'+id+'-st'+s+'-alpha'); }
    return p; }
  p(props,n,d=0){ const v=parseFloat((props.get(n)||'').toString()); return Number.isFinite(v)?v:d; }
  pal(props,i){ i=Math.max(1,Math.min(6,Math.floor(i))); return [this.p(props,'--g'+i+'-r',255),this.p(props,'--g'+i+'-g',255),this.p(props,'--g'+i+'-b',255),this.p(props,'--g'+i+'-a',1)]; }
  hash(x,y){ return (Math.sin(x*127.1+y*311.7)*43758.5453)%1; }
  comp(v){ const m=['source-over','overlay','screen','multiply','soft-light','hard-light','color-dodge','color-burn','difference','luminosity']; return m[Math.max(0,Math.min(m.length-1,Math.floor(v)))]||'source-over'; }
  grad(ctx,t,a,cx,cy,w,h,b){ if(t===1) return ctx.createLinearGradient(cx-Math.cos(a)*cx,cy-Math.sin(a)*cy,cx+Math.cos(a)*cx,cy+Math.sin(a)*cy); if(t===2) return ctx.createRadialGradient(cx,cy,b*0.2,cx,cy,Math.max(w,h)*0.6); return ctx.createConicGradient(a,cx,cy); }
  lineCenter(border,width,offset,band){ if(band==='o') return Math.max(width*.5,width*.5+offset); if(band==='i') return Math.max(width*.5,border-width*.5+offset); return Math.max(width*.5,border*.5+offset); }
  strokeBand(ctx,inset,w,h,r,width){ if(width<=0||w<=inset*2||h<=inset*2) return; ctx.lineWidth=width; ctx.beginPath(); ctx.roundRect(inset,inset,Math.max(0,w-inset*2),Math.max(0,h-inset*2),Math.max(0,r-inset)); ctx.stroke(); }
  stops(props,p){ const st=[]; for(let i=1;i<=4;i++) st.push({pos:Math.max(0,Math.min(1,this.p(props,'--'+p+'-st'+i+'-pos',(i-1)/3))),pal:this.p(props,'--'+p+'-st'+i+'-palette',i),am:this.p(props,'--'+p+'-st'+i+'-alpha',1)}); st.sort((a,b)=>a.pos-b.pos); return st; }
  layerBegin(ctx,props,p){ if(this.p(props,'--'+p+'-layer-enable',0)>=.5){ ctx.globalCompositeOperation=this.comp(this.p(props,'--'+p+'-layer-blend',0)); ctx.globalAlpha=Math.max(0,Math.min(1,this.p(props,'--'+p+'-layer-opacity',1))); ctx.filter='brightness('+this.p(props,'--'+p+'-layer-brightness',1)+') contrast('+this.p(props,'--'+p+'-layer-contrast',1)+') saturate('+this.p(props,'--'+p+'-layer-saturate',1)+') hue-rotate('+this.p(props,'--'+p+'-layer-hue',0)+'deg) blur('+this.p(props,'--'+p+'-layer-blur',0)+'px)'; } else { ctx.globalCompositeOperation='source-over'; ctx.globalAlpha=1; ctx.filter='none'; } }
  layerEnd(ctx){ ctx.globalCompositeOperation='source-over'; ctx.globalAlpha=1; ctx.filter='none'; }
  drawBg(ctx,props,p,w,h,cx,cy,angle,border,r,c,width){ if(this.p(props,'--'+p+'-bg-enable',0)<.5) return; const gAngle=(this.p(props,'--'+p+'-bg-angle',0)+(this.p(props,'--'+p+'-bg-animate',0)>=.5?angle*180/Math.PI:0))*Math.PI/180; const g=this.grad(ctx,Math.floor(this.p(props,'--'+p+'-bg-type',0)),gAngle,cx,cy,w,h,border); for(const s of this.stops(props,p)){ const col=this.pal(props,s.pal); g.addColorStop(s.pos,'rgba('+col[0]+','+col[1]+','+col[2]+','+(col[3]*s.am*this.p(props,'--'+p+'-bg-alpha',1))+')'); } ctx.globalCompositeOperation=this.comp(this.p(props,'--'+p+'-bg-blend',0)); ctx.strokeStyle=g; this.strokeBand(ctx,c,w,h,r,width); ctx.globalCompositeOperation='source-over'; }
  drawConic(ctx,props,p,w,h,cx,cy,angle,r,c,width){ if(this.p(props,'--'+p+'-conic-enable',0)<.5) return; const arms=Math.max(1,Math.floor(this.p(props,'--'+p+'-arms-count',10))), aw=Math.max(.01,Math.min(.99,this.p(props,'--'+p+'-arms-width',.3))), ac=this.p(props,'--'+p+'-arms-contrast',.5), spin=this.p(props,'--'+p+'-arms-spin',1.2), aMul=this.p(props,'--'+p+'-conic-alpha',1); const arm=ctx.createConicGradient(angle*spin,cx,cy); for(let i=0;i<arms;i++){ const s=i/arms,m=(i+aw*.5)/arms,e=(i+aw)/arms; arm.addColorStop(s%1,'rgba(255,255,255,0)'); arm.addColorStop(m%1,'rgba(255,255,255,'+(0.34*ac*aMul)+')'); arm.addColorStop(e%1,'rgba(0,0,0,'+(0.16*ac*aMul)+')'); } ctx.globalCompositeOperation=this.comp(this.p(props,'--'+p+'-conic-blend',1)); ctx.strokeStyle=arm; this.strokeBand(ctx,c,w,h,r,width); ctx.globalCompositeOperation='source-over'; }
  drawFresnel(ctx,props,p,w,h,r,c,width,elev,inten){ if(this.p(props,'--'+p+'-fresnel-enable',0)<.5) return; const s=this.p(props,'--'+p+'-fresnel-strength',.4); if(s<=0) return; const fw=this.p(props,'--'+p+'-fresnel-width',.35), fp=Math.max(.2,this.p(props,'--'+p+'-fresnel-power',3)), col=this.pal(props,this.p(props,'--'+p+'-fresnel-palette',6)), mul=this.p(props,'--'+p+'-fresnel-alpha-mul',1), steps=Math.max(8,Math.floor(width*2)); for(let i=0;i<steps;i++){ const t=i/steps, edge=Math.abs((t-.5)/.5), fr=Math.pow(1-edge,fp)*s*(.5+elev*.75)*inten, a=fr*Math.max(0,1-Math.abs(t-fw)); if(a<.0007) continue; ctx.strokeStyle='rgba('+col[0]+','+col[1]+','+col[2]+','+(col[3]*a*mul)+')'; this.strokeBand(ctx,c-width*.5+t*width,w,h,r,Math.max(.45,width/steps+.2)); } }
  drawTexture(ctx,props,p,w,h,r,c,width,angle){ if(this.p(props,'--'+p+'-texture-enable',0)<.5) return; const tt=Math.floor(this.p(props,'--'+p+'-texture-type',1)); if(tt===0) return; const ts=Math.max(.1,this.p(props,'--'+p+'-texture-scale',1)), ta=this.p(props,'--'+p+'-texture-strength',.35), tr=this.p(props,'--'+p+'-texture-roughness',.3), col=this.pal(props,this.p(props,'--'+p+'-tex-palette',1)), am=this.p(props,'--'+p+'-tex-alpha-mul',1), rw=Math.max(1,w-c*2), rh=Math.max(1,h-c*2), cnt=Math.min(1800,Math.floor((2*(rw+rh))*(0.12+ts*0.09))), aBase=Math.max(0,col[3]*ta*am); ctx.strokeStyle='rgba('+col[0]+','+col[1]+','+col[2]+','+(aBase*0.3)+')'; ctx.fillStyle='rgba('+col[0]+','+col[1]+','+col[2]+','+(aBase*0.22)+')'; for(let i=0;i<cnt;i++){ const u=i/cnt, side=Math.floor(u*4), t=(u*4)-side; let x=0,y=0; if(side===0){x=c+rw*t;y=c;} else if(side===1){x=c+rw;y=c+rh*t;} else if(side===2){x=c+rw*(1-t);y=c+rh;} else {x=c;y=c+rh*(1-t);} const jx=(this.hash(i,13.1)-0.5)*width*(0.6+tr), jy=(this.hash(i,27.7)-0.5)*width*(0.6+tr), px=x+jx, py=y+jy; if(tt===1){ const tang=angle+(this.hash(i,9.1)-0.5)*0.8, len=1.2+this.hash(i,55.1)*width*0.7; ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(px+Math.cos(tang)*len,py+Math.sin(tang)*len); ctx.stroke(); } else if(tt===2){ const len=1.1+this.hash(i,44.2)*width*0.75; ctx.beginPath(); ctx.moveTo(px-len,py); ctx.lineTo(px+len,py); ctx.stroke(); } else if(tt===3){ const a=angle + u*Math.PI*2*(0.8+ts*0.5), len=1+this.hash(i,88.1)*width*0.7; ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(px+Math.cos(a)*len,py+Math.sin(a)*len); ctx.stroke(); } else if(tt===4){ const rr=.45+this.hash(i,71.9)*2.6*(0.6+tr); ctx.beginPath(); ctx.arc(px,py,rr,0,Math.PI*2); ctx.stroke(); } else if(tt===5){ const rr=.2+this.hash(i,41.3)*1.5; ctx.beginPath(); ctx.arc(px,py,rr,0,Math.PI*2); ctx.fill(); } else if(tt===6){ const l=0.6+this.hash(i,62.2)*2.1; ctx.beginPath(); ctx.moveTo(px-l,py); ctx.lineTo(px+l,py); ctx.moveTo(px,py-l); ctx.lineTo(px,py+l); ctx.stroke(); } else if(tt===7){ const rr=.35+this.hash(i,19.2)*1.9*(0.5+tr); ctx.fillRect(px-rr*.5,py-rr*.5,rr,rr); } else if(tt===8){ const rr=.6+this.hash(i,33.2)*2.8*(0.7+tr); ctx.beginPath(); ctx.arc(px,py,rr,0,Math.PI*2); ctx.fill(); } else if(tt===9){ const rr=.7+this.hash(i,12.4)*2.4*(0.8+tr); ctx.beginPath(); ctx.arc(px,py,rr,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='rgba(125,72,42,'+(aBase*0.35)+')'; ctx.beginPath(); ctx.arc(px,py,rr*0.65,0,Math.PI*2); ctx.stroke(); ctx.strokeStyle='rgba('+col[0]+','+col[1]+','+col[2]+','+(aBase*0.3)+')'; } } }
  paint(ctx,size,props){ const w=size.width,h=size.height,b=Math.max(0,this.p(props,'--border-size',12)),rad=Math.max(0,this.p(props,'--radius',24)); if(b<=.01) return; const a=((this.p(props,'--base-angle',0)+this.p(props,'--scroll-progress',0)*360*this.p(props,'--scroll-drive',1))%360)*Math.PI/180,elev=this.p(props,'--light-elevation',.78),inten=this.p(props,'--light-intensity',1.2),cx=w*.5,cy=h*.5;
    for(const p of ['m','o','s','i']){ if(this.p(props,'--'+p+'-enable',0)<.5) continue; const width=Math.max(0,this.p(props,'--'+p+'-width',6)); if(width<=.01) continue; const c=this.lineCenter(b,width,this.p(props,'--'+p+'-offset',0),p); this.layerBegin(ctx,props,p); const co=Math.floor(this.p(props,'--'+p+'-conic-order',1)); if(co===0) this.drawConic(ctx,props,p,w,h,cx,cy,a,rad,c,width); this.drawBg(ctx,props,p,w,h,cx,cy,a,b,rad,c,width); if(co!==0) this.drawConic(ctx,props,p,w,h,cx,cy,a,rad,c,width); this.drawFresnel(ctx,props,p,w,h,rad,c,width,elev,inten); this.drawTexture(ctx,props,p,w,h,rad,c,width,a); this.layerEnd(ctx);} }
}
registerPaint('metal-stack', MetalStackPainter);
